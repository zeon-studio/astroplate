---
import { Image } from "astro:assets";

interface Props {
  src: string | ImageMetadata; // æ¥å—å­—ç¬¦ä¸²è·¯å¾„æˆ–å¯¼å…¥çš„ ImageMetadata
  alt?: string;
  width?: number; 
  height?: number; 
  loading?: "eager" | "lazy" | null | undefined;
  decoding?: "async" | "auto" | "sync" | null | undefined;
  format?: "auto" | "avif" | "jpeg" | "png" | "svg" | "webp";
  class?: string;
  style?: any;
  [key: string]: any;
}

let {
  src,
  alt,
  width,
  height,
  loading,
  decoding,
  format,
  style,
  class: className,
  ...rest
} = Astro.props;

// æ£€æŸ¥ src æ˜¯å¦å·²ç»æ˜¯å¯¼å…¥çš„ ImageMetadata å¯¹è±¡
const isImageModule = typeof src !== 'string';
const isRemoteImage = typeof src === 'string' && (src.startsWith("http://") || src.startsWith("https://") || src.startsWith("//"));

// ğŸŒŸ å…³é”®ï¼šå¦‚æœ src æ˜¯è·¯å¾„å­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬å‡è®¾å®ƒæ˜¯ public/ è·¯å¾„æˆ–è¿œç¨‹è·¯å¾„ã€‚
// å¦‚æœå®ƒæ˜¯ ImageMetadataï¼Œåˆ™ä½¿ç”¨ <Image /> ä¼˜åŒ–ã€‚
const finalSrc = isImageModule ? src : src.toString(); 

// æ£€æŸ¥æ˜¯å¦ä¸ºè‡ªé€‚åº”å›¾ç‰‡ï¼Œä»¥å†³å®šæ˜¯å¦ä¼ é€’ width/height
const isContained = className && (className.includes('object-cover') || className.includes('w-full') || className.includes('h-full'));

// åªæœ‰åœ¨å›¾ç‰‡ä¸æ˜¯è‡ªé€‚åº”å®¹å™¨çš„ä¸€éƒ¨åˆ†æ—¶ï¼Œæ‰ä¼ é€’å°ºå¯¸
const passWidth = isContained ? undefined : width;
const passHeight = isContained ? undefined : height;

const finalPassWidth = (typeof passWidth === 'number' && passWidth > 0) ? passWidth : undefined;
const finalPassHeight = (typeof passHeight === 'number' && passHeight > 0) ? passHeight : undefined;
---

{
  !isImageModule && isRemoteImage ? (
    <img
      src={finalSrc as string}
      alt={alt || ""}
      width={finalPassWidth}
      height={finalPassHeight}
      loading={loading}
      decoding={decoding}
      class={className}
      style={style}
      {...rest}
    />
  ) : isImageModule ? (
    <Image
      src={finalSrc as ImageMetadata}
      alt={alt || ""}
      width={finalPassWidth}
      height={finalPassHeight}
      loading={loading}
      decoding={decoding}
      format={format}
      class={className}
      style={style}
      {...rest}
    />
  ) : (
    <img
      src={finalSrc as string}
      alt={alt || ""}
      width={finalPassWidth}
      height={finalPassHeight}
      loading={loading}
      decoding={decoding}
      class={className}
      style={style}
      {...rest}
    />
  )
}
